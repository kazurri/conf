#!/bin/bash
#
# Weather
# =======
#
# By Jezen Thomas <jezen@jezenthomas.com>
#
# This script sends a couple of requests over the network to retrieve
# approximate location data, and the current weather for that location. This is
# useful if for example you want to display the current weather in your tmux
# status bar.

# There are three things you will need to do before using this script.
#
# 1. Install jq with your package manager of choice (homebrew, apt-get, etc.)
# 2. Sign up for a free account with OpenWeatherMap to grab your API key
# 3. Add your OpenWeatherMap API key where it says API_KEY

# OPENWEATHERMAP API KEY (place yours here)
API_KEY="413938bf72b9c28f84ac284a373da149"

set -e

# Not all icons for weather symbols have been added yet. If the weather
# category is not matched in this case statement, the command output will
# include the category ID. You can add the appropriate emoji as you go along.
#
# Weather data reference: http://openweathermap.org/weather-conditions
weather_icon() {
  case $1 in
	200|201|202|210|211|212|221|230|231|232) echo 🌩
	  ;;
    300|301|302|310|311|312|313|314|321) echo 🌧
      ;;
    500|501|502|503|504) echo 🌦
      ;;
	511) echo 🌨
	  ;;
    520|521|522|531) echo 🌧
      ;;
    600|601|602|611|612|615|616|620|621|622) echo ❄️
      ;;
    701|711|721|731|741|751|761|762|771|781) echo 🌫
      ;;
    800) echo ☀️
      ;;
    801) echo 🌤
      ;;
    802) echo ⛅️
      ;;
    803) echo ⛅️
      ;;
    804) echo ☁️
      ;;
	900|901|902) echo 🌪
	  ;;
    *) echo "$1"
  esac
}

#LOCATION=$(curl --silent http://ip-api.com/csv)
#CITY=$(echo "$LOCATION" | cut -d , -f 6)
#LAT=$(echo "$LOCATION" | cut -d , -f 8)
#ON=$(echo "$LOCATION" | cut -d , -f 9)
CITY=Tokyo
LAT=35.6900
LON=139.6900

WEATHER=$(curl --silent http://api.openweathermap.org/data/2.5/weather\?lat="$LAT"\&lon="$LON"\&APPID="$API_KEY"\&units=metric)

CATEGORY=$(echo "$WEATHER" | jq .weather[0].id)
TEMP="$(echo "$WEATHER" | jq .main.temp | cut -d . -f 1)°C"
WIND_SPEED="$(echo "$WEATHER" | jq .wind.speed | awk '{print int($1+0.5)}')ms"
ICON=$(weather_icon "$CATEGORY")

printf "%s" "$CITY $ICON  $TEMP $WIND_SPEED"
